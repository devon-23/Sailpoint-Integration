<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Rule PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Rule language="beanshell" name="Test Email Template">
  <Source><![CDATA[
  import sailpoint.object.EmailTemplate;
  import sailpoint.object.EmailOptions;
  import sailpoint.api.SailPointContext;
  import sailpoint.tools.GeneralException;
  import sailpoint.object.QueryOptions;
  import sailpoint.object.Filter;
  import java.util.List;
  import java.util.ArrayList;
  import sailpoint.object.Application;
  import sailpoint.object.Identity;
  import sailpoint.object.Link;
  import sailpoint.object.QueryOptions;
  import sailpoint.object.Filter;

  import sailpoint.object.EmailTemplate;
  import sailpoint.object.QueryOptions;
  import java.util.*;

  import sailpoint.object.TaskResult;
  import sailpoint.object.TaskDefinition;
  import sailpoint.object.TaskSchedule;

  import sailpoint.tools.Message.Type;
  import sailpoint.tools.*;
  import sailpoint.tools.Message;
  import sailpoint.tools.Util;

  try {
      tempNames = taskResult.getDefinition().getString("templates");
    	emailid = taskResult.getDefinition().getString("email");
      String[] templateArr = tempNames .split(","); 
    
      for (String name : templateArr ) {
       name = name.trim();

        if (name.isEmpty()) {
          continue;
        }
        
        EmailTemplate template = context.getObjectByName(EmailTemplate.class, name);
        
        if (template == null) {
          Message msg = new Message(Message.Type.Warn, "Warning: Template not found:: " + name ". Unable to send email" , new Object[] {});
          taskResult.addMessage(msg);
          continue;
        }
  
        EmailOptions options = new EmailOptions();
        
        options.setTo(emailid);
        
        Map args = new HashMap();
        args.put("identityName", "Test User");
        args.put("applicationName", "Test App");
        args.put("certificationName", "Test Certification");
      	args.put("workItemName", "Test workitem");
      	args.put("fname", "first name");
      	args.put("lname", "last name");
        args.put("delegateeName", "Delegatee");
       	args.put("workitem", "workitem Test");
       	args.put("requesterName", "Requester");
       	args.put("comments", "Test Comments");
       	args.put("certDef", "Test certDef");
       	args.put("time", "Test time");
       	args.put("certification", "Test certification");
       	args.put("applications", "Test applications");
       	args.put("workflow", "Test workflow");
       	args.put("approvalSet", "Test ApprovalSet");
       	args.put("launcher", "Test launcher");
       	args.put("identityDisplayName", "Test identityDisplayName");
       	args.put("identityRequestId", "Test identityRequestId");
       	args.put("user", "Test user");
        args.put("name", "Test name");
        args.put("ownerName", "Test ownerName");
     
        options.setVariables(args);

        try {
            context.sendEmailNotification(template, options);
          	taskResult.addMessage("Email Sent:: " + name);  
        } catch (Exception e) {
            Message msg = new Message(Message.Type.Warn, "Warning: unable to send email with template: " + name + " and email address: " + emailid, new Object[] {});
      			taskResult.addMessage(msg);  
        }
    }
  } catch (Exception e) {
            log.error("Test email template Rule failed: ", e);
    				Message msg = new Message(Message.Type.Error, "Test email template Rule failed ", new Object[] {});
      			taskResult.addMessage(msg); 
  }
  
  finally { 
    taskResult.getDefinition().setArgument("templates","");
    taskResult.getDefinition().setArgument("email","");
    context.saveObject(taskResult.getDefinition());
    context.commitTransaction();
  } 

return "Done...";
 
  ]]></Source>
</Rule>
